{% extends 'base.html' %}
{% block content %}
<div class="glass-panel">
    <div class="dashboard-header">
        <h2 class="animated-heading">Admin Dashboard</h2>
        <a href="/handle_requests" class="notification-badge animated-button">
            üîî Requests {% if requests_count > 0 %}<span class="count">{{ requests_count }}</span>{% endif %}
        </a>
    </div>

    <!-- Add Parcel Section -->
    <div class="accordion-section">
        <h3 class="accordion-toggle">‚ûï Add New Parcel</h3>
        <div class="accordion-content">
            <form method="POST" action="/add_parcel" enctype="multipart/form-data" class="grid-form">
                <input type="text" name="id" placeholder="Parcel ID (Auto if empty)" value="">
                <input type="text" name="name" placeholder="Receiver Name" required>
                <select name="status" required>
                    <option value="Pending Pickup">Pending Pickup</option>
                    <option value="In Transit">In Transit</option>
                    <option value="Out for Delivery">Out for Delivery</option>
                    <option value="Delivered">Delivered</option>
                </select>
                <input type="text" name="start_address" placeholder="Start Address" required>
                <input type="text" name="address" placeholder="End Address" required>
                <input type="text" name="price" placeholder="Price" required>
                <input type="text" name="phone" placeholder="Receiver Phone" required>
                <input type="email" name="email" placeholder="Receiver Email" required>
                <select name="payment_type" required>
                    <option value="Prepaid">Prepaid</option>
                    <option value="Postpaid">Postpaid</option>
                </select>
                <input type="text" name="region" placeholder="Region" required>
                <div class="file-input-group">
                    <label>Parcel Image:</label>
                    <input type="file" name="image">
                </div>
                <button type="submit" class="animated-button primary-btn">Add Parcel</button>
            </form>
        </div>
    </div>

    <!-- Incoming Requests Section -->
    <div class="incoming-requests">
        <h3>üì© Incoming Parcel Requests</h3>
        <div class="requests-grid">
            {% for parcel in parcels %}
            {% if parcel.status == 'Pending Approval' %}
            <div class="request-card glass-panel">
                <div class="req-header">
                    <h4>{{ parcel.name }}</h4>
                    <span class="req-id">{{ parcel.id }}</span>
                </div>
                <div class="req-details">
                    <p><strong>From:</strong> {{ parcel.start_address }}</p>
                    <p><strong>To:</strong> {{ parcel.address }}</p>
                    <p><strong>Phone:</strong> {{ parcel.phone }}</p>
                </div>
                {% if parcel.image %}
                <img src="{{ url_for('static', filename=parcel.image) }}" class="req-img-preview">
                {% endif %}
                <div class="req-actions">
                    <a href="/approve_parcel/{{ parcel.id }}" class="action-btn approve">‚úÖ Approve</a>
                    <a href="/reject_parcel/{{ parcel.id }}" class="action-btn reject">‚ùå Reject</a>
                </div>
            </div>
            {% endif %}
            {% endfor %}
        </div>
    </div>

    <div class="filters glass-panel-light">
        <input type="text" id="searchInput" placeholder="Search Parcel by ID or Name..." onkeyup="filterTable()">
        <select id="statusFilter" onchange="filterTable()">
            <option value="">All Status</option>
            <option value="PENDING PICKUP">Pending Pickup</option>
            <option value="IN TRANSIT">In Transit</option>
            <option value="DELIVERED">Delivered</option>
        </select>
    </div>

    <h3>üì¶ Active Shipments</h3>
    <div class="table-container">
        <table id="parcelTable" class="glass-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Image</th>
                    <th>Name</th>
                    <th>Status</th>
                    <th>Current Loc</th>
                    <th>Start</th>
                    <th>End</th>
                    <th>Region</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for parcel in parcels %}
                {% if parcel.status != 'Pending Approval' %}
                <tr>
                    <td>{{ parcel.id }}</td>
                    <td>
                        {% if parcel.image %}
                        <a href="{{ url_for('static', filename=parcel.image) }}" target="_blank"
                            title="View Image">üì∏</a>
                        {% else %}
                        <span>-</span>
                        {% endif %}
                    </td>
                    <td>{{ parcel.name }}</td>
                    <td><span class="status-pill {{ parcel.status|lower|replace(' ','-') }}">{{ parcel.status }}</span>
                    </td>
                    <td>{{ parcel.current_location }}</td>
                    <td>{{ parcel.start_address }}</td>
                    <td>{{ parcel.address }}</td>
                    <td>{{ parcel.region }}</td>
                    <td>
                        <a href="/edit_parcel/{{ parcel.id }}" class="action-btn edit" title="Edit">‚úèÔ∏è</a>
                        <a href="/print_label/{{ parcel.id }}" class="action-btn print" target="_blank"
                            title="Print Label">üñ®Ô∏è</a>
                        <form method="POST" action="/delete_parcel" style="display:inline;"
                            onsubmit="return confirm('Are you sure?');">
                            <input type="hidden" name="id" value="{{ parcel.id }}">
                            <button type="submit" class="action-btn delete" title="Delete">üóëÔ∏è</button>
                        </form>
                    </td>
                </tr>
                {% endif %}
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    function filterTable() {
        var searchInput = document.getElementById("searchInput").value.toUpperCase();
        var statusFilter = document.getElementById("statusFilter").value.toUpperCase();

        var table = document.getElementById("parcelTable");
        var tr = table.getElementsByTagName("tbody")[0].getElementsByTagName("tr");

        for (var i = 0; i < tr.length; i++) {
            var tdId = tr[i].getElementsByTagName("td")[0];
            var tdName = tr[i].getElementsByTagName("td")[1];
            var tdStatus = tr[i].getElementsByTagName("td")[2];

            if (tdId && tdName) {
                var txtValueId = tdId.textContent || tdId.innerText;
                var txtValueName = tdName.textContent || tdName.innerText;
                var txtValueStatus = tdStatus.textContent || tdStatus.innerText;

                var matchesSearch = txtValueId.toUpperCase().indexOf(searchInput) > -1 || txtValueName.toUpperCase().indexOf(searchInput) > -1;
                var matchesStatus = statusFilter === "" || txtValueStatus.toUpperCase().indexOf(statusFilter) > -1;

                if (matchesSearch && matchesStatus) {
                    tr[i].style.display = "";
                } else {
                    tr[i].style.display = "none";
                }
            }
        }
    }
</script>
{% endblock %}